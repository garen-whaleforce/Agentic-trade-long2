# V10 Combined TP10 Frozen Configuration — Paper Trading
# Frozen at: 2026-02-11
# Upgrade from: V9 G2 TP10 (Sharpe 2.031 → V10 Combined Sharpe 2.321)
# Features: V9 16 + candle 6 + company_dna 3 = 25

# ── Model ──────────────────────────────────────────────────────────
model_path: "models/v10_combined_model_20260211_141639.pkl"
model_type: "GradientBoosting"
model_params:
  n_estimators: 100
  max_depth: 3
  learning_rate: 0.08
  subsample: 0.8
  random_state: 42

# ── Features (25 total, must match model bundle) ──────────────────
# V9 base: 16 features
# Candle: 6 features (require OHLCV data for T0, T1, and 20d lookback)
# Company DNA: 3 features (from company_dna_cache.json, Bayesian-shrunk)
feature_count: 25
feature_names:
  # V9 base (16)
  - drop_1d
  - eps_surprise
  - eps_beat
  - abs_drop
  - sector_return_20d
  - sector_breadth
  - spy_above_200dma
  - drop_x_sector
  - sector_x_eps_sign
  - beat_dump
  - value_trap_score
  - justified_drop
  - sector_divergence
  - drop_squared
  - bear_duration_days
  - vix_percentile
  # Candle (6)
  - gap_pct             # (T1 open - T0 close) / T0 close
  - intraday_ret        # (T1 close - T1 open) / T1 open
  - close_pos           # (T1 close - T1 low) / (T1 high - T1 low)
  - range_pct           # (T1 high - T1 low) / T1 open
  - range_over_atr      # T1 range / 20d ATR
  - rel_vol             # T1 volume / 20d avg volume
  # Company DNA (3)
  - hist_bounce_rate    # Bayesian-shrunk bounce rate (prior_weight=3)
  - hist_avg_return     # Bayesian-shrunk avg 30d return
  - n_prior_events      # min(n, 10) / 10.0

# ── Company DNA Cache ─────────────────────────────────────────────
company_dna:
  cache_path: "signals/company_dna_cache.json"
  prior_weight: 3
  global_bounce_rate: 0.523
  global_avg_return: 0.037
  n_symbols: 330
  label_threshold: 0.01
  default_values:
    hist_bounce_rate: 0.5
    hist_avg_return: 0.03
    n_prior_events: 0
  # Refresh: monthly (new events have minimal impact due to Bayesian shrinkage)

# ── Trading Parameters ─────────────────────────────────────────────
threshold: 0.58
stop_loss: 0.10          # 10% close-based
weight: 0.15             # 15% of basis_equity per trade
leverage: 2.5            # max exposure = equity × 2.5
slippage: 0.001          # 0.10% estimated slippage per trade
commission_per_share: 0.005

# ── Dynamic Exit Rule (TP10) ─────────────────────────────────────
exit_rule:
  type: "take_profit_or_max_hold"
  take_profit: 0.10      # exit when cumulative return >= +10%
  max_hold: 30           # fallback: T+30 trading days
  check_frequency: "daily"  # check TP condition daily at close

# ── Half-Weight First Month ────────────────────────────────────────
half_weight_enabled: false  # V10 inherits V9 paper trading history
half_weight_until: null
half_weight_factor: 1.0

# ── Data Sources ───────────────────────────────────────────────────
db:
  host: "172.23.22.100"
  port: 5432
  user: "whaleforce"
  password: ""
  database: "pead_reversal"

tables:
  events: "earnings_surprises"
  prices: "historical_prices"
  companies: "companies"
  transcripts: "transcript_content"

# ── Pipeline Logic (frozen, not configurable) ──────────────────────
event_detection:
  min_drop: -0.05        # drop >= 5%
  require_eps_actual: true
  require_eps_estimated: true

sector_momentum:
  lookback_calendar_days: 33   # ~20 trading days
  default_return: 0.0
  default_breadth: 0.5

spy_200dma:
  lookback: 200
  max_bear_duration: 200
  bear_duration_normalized: true  # divide by 200

vix_percentile:
  window: 252
  min_lookback: 60
  default: 0.5

# ── Event-level Data Flow ──────────────────────────────────────────
# 1. Query earnings_surprises for target date
# 2. JOIN companies for sector
# 3. Get price_t0 (event_date close) and price_t1 (next trading day close)
# 4. Filter: (price_t1 - price_t0) / price_t0 <= -0.05
# 5. Compute 16 V9 features (sector momentum, SPY 200DMA, VIX percentile)
# 6. Compute 6 candle features (OHLCV for T0, T1, 20d lookback)
# 7. Load 3 company DNA features from cache (fallback to defaults)
# 8. Model predict_proba → prob (25 features)
# 9. If prob >= 0.58 → BUY signal
# 10. Entry: T+1 close price
# 11. Exit: first of — TP (+10%) / SL (-10%) / MaxHold (T+30)
# 12. Daily check open positions for TP/SL trigger

# ── Backtester API Validation ──────────────────────────────────────
api_backtest_ids:
  v10_combined: "9272d16d-adb3-4e6e-8057-b56abfe954dd"
  v10_candle: "dc3a652b-8b23-4a4a-aa53-da9c23026047"
  v10_company_dna: "b09a7360-704c-4e30-9476-30b65530e497"
  v9_baseline: "210aa37b-7c16-44e1-b280-fd32c32e0e98"

api_results:
  # V10 Combined (current frozen config)
  full_cagr: 57.5
  full_sharpe: 2.321
  full_mdd: 19.8
  full_sortino: 3.62
  full_calmar: 2.90
  full_total_return: 5555.7
  trades: 495
  # V9 G2 TP10 (previous, for reference)
  v9_cagr: 47.1
  v9_sharpe: 2.031
  v9_mdd: 23.7

# ── Upgrade Notes ─────────────────────────────────────────────────
# V10 vs V9 improvement (API validated):
#   Sharpe: 2.031 → 2.321 (+0.290)
#   CAGR:   47.1% → 57.5% (+10.4pp)
#   MDD:    23.7% → 19.8% (-3.9pp)
#   Trades: 415 → 495 (+80)
# Shrinkage: 90-102% (GENUINE, not overfit)
# Note: API validation used 33 features (incl. pre_earnings).
#   Production uses 25 features (no pre_earnings — too expensive for FMP).
#   Expected Sharpe between candle-only (2.253) and full combined (2.321).

# ── Audit Trail ────────────────────────────────────────────────────
audit:
  v9_issues_found: 8
  v9_p0_issues: 3
  survivorship_bias_impact_pp: 5.3
  seed_stability_f1_std: 0.020
  v10_research_log: "docs/v10_research_log.md"
  v10_research_script: "scripts/v10_feature_research.py"
  v10_validation_script: "scripts/submit_v10_api_validation.py"
  v10_training_script: "scripts/train_v10_combined.py"

# ── Version History ────────────────────────────────────────────────
# v10_combined_tp10_20260211: V10 Combined (25 features) upgrade
# v9_g2_tp10_20260209: V9 with TP10 dynamic exit (Sharpe 2.031)
# v9_g2_frozen_20260208: Initial V9 freeze
version: "v10_combined_tp10_20260211"
